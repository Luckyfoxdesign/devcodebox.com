# Pyper blog

Pyper – это приложениие для ведения блога.

Приложение состоит из трех частей. Sapper для фронтенда, nodejs/express для промежуточного прокси сервера и nodejs/express для бекенда, который обрабатывает запросы к MongoDB.

## Содержание
- [Pyper blog](#pyper-blog)
  - [Содержание](#содержание)
- [Запуск](#запуск)
  - [Настройка базы данных](#настройка-базы-данных)
  - [Настройка приложения](#настройка-приложения)
- [Какие функции реализованы](#какие-функции-реализованы)
- [Цель проекта](#цель-проекта)
- [Сложности с которыми столкнулся](#сложности-с-которыми-столкнулся)
- [Когда нибудь я сделаю вот это](#когда-нибудь-я-сделаю-вот-это)
- [Демо видео](#демо-видео)
- [Contribution](#contribution)

# Запуск

Как запустить на VPS - не знаю. Не запускал. Поэтому весь остальной текст будет про локалку.

Тестировал с autocannon, выдеживает до 800 одновременных соединений для главной страницы. С авторизацией и регистрацией будет гораздо ниже. Ну и тестировал я скорее всего неправильно.

В общем как разберусь с настройкой CI/CD, чтобы вручную не подтягивать изменения и не ребилдить, запущу и на VPS. Но юбудет это не скоро.


## Настройка базы данных

Чтобы все заработало, у вас должна быть установленная и рабочая MongoDB. Хоть на сервере хоть на локалке не суть важно. Базы данных нужно подготовить заранее, т.к они автоматически при запросе не создадутся в данном случае. Коллекции можно не создавать, они уже создадутся автоматически при подключении к бд.

> Если вы ну вот ни разу не работали с MongoDB, уж извините, детально рассказывать про настройку не буду, оставляю вам самим пройти этот непростой но интересный квест, какой прошел и я.

Структура без дефолтных баз:

- `articles_db` - база для опубликованных статей и черновиков
  - `draftArticles_collection`
  - `publicArticles_collection`
- `sessions_db` - сессии у меня висят тоже на MongoDB
  - `sessions`
- `users_db` - база для регистрации пользователей
  - `user_collection`

Сейчас доступ ко всем базам происходит через единственного пользователя лежащего в `admin` с правами на чтение и запись на все базы. Как делать правильно - еще не изучал, но со временем найду ответ.

В `config/config.js` нужно указать в переменных логин/пароль, либо сделать через переменные окружения - на ваше усмотрение.


## Настройка приложения

Настраивать приложение не нужно, скрипты запуска прокси, фронта и бекэнда - `npm run dev`.

Бекэнд лежит в папке `api`, прокси лежит в `proxy`.

**Не забудьте установить зависимости.**

# Какие функции реализованы
- Пользователь
  - Регистрация
  - Авторизация
  - Удаление аккаунта
  - Смена пароля
- Статьи
  - Публикация
  - Сохранение в черновики
  - Редактирование черновика
  - Публикация черновика
- Редактор
  - Добавление параграфа
  - Добавление заголовка второго уровня
  - Добавление картинки

# Цель проекта

Делал для:
- изучения MongoDB
- практики в создании клиент-серверного приложения
- себя, давно хотел свой блог

# Сложности с которыми столкнулся

Изначально цель была сделать принцип редактирования как у телеграфа, но спустя время понял какие у меня ограничения и что мой текущий уровень не позволяет их преоделеть.

1. Самое сложное из ограничений - определение позиции каретки при различных манипуляциях с текстом: *выделении, удалении, переход на новую строку* и.т.д

Готовые пакеты принципиально не использовал. Какой я программист если не сделаю свое и "*круче*". Все найденные библиотеки, используют `execCommand` который помечен как `deprecated` т.к оно работает в каждом браузере по своему, исходя из документации на MDN. В итоге все работает "*по кнопке*".

2. Вторая сложность заключается в том, что я непонимаю как работает Express внутри и как работают `async` middleware для роутов и следовательно не знаю как все сделать лучше. Event loop, стек, нода все остальное - слишком много абстракций, не вывожу, нужно время и упорядоченность знаний.
3. Без понятия как развертывать приложение так, чтобы вручную не подтягивать все изменения с Github и автоматически ребилдить. В итоге все сейчас только на локалке.

# Когда нибудь я сделаю вот это

Если мне будет не лень, то думаю сделать следующие вещи:

- [ ] Хочется оптимизировать работу с данными и при возможности переиспользовать store, вместо того, чтобы повторно запрашивать уже загруженные данные;
- [ ] Много мест, где функции дублируются и можно вытащить их в одно место;
- [ ] Много мест, где можно выделить html в отдельные компоненты, например кнопки. Добавить может быть возможность выбора типа, primary, secondary, на основе одного компонента;
- [ ] Получше организовать роуты на бэкенде, сейчас почти на каждый роут отдельная папка;
- [ ] Разобраться с прокси-сервером чтобы понять, как с его помощью обезопасить бэкенд и можно ли;
- [ ] Добавить форматирование текста
- [ ] Добавить перемещение элементов вверх-вниз
- [ ] Сделать добавление элементов не через кнопку, а через форматирование
- [ ] Может быть перейду на SvelteKit
- [ ] Подумать над организацией запросов к бекэнду, некоторые запросы обращаются к одним и тем же роутам, но за разными данными, ок не ок...

# Демо видео

[![Sapper/Express/MongoDB demo video](img/DemoVideo.png)](https://youtu.be/Vl1mEO2HqNg)

# Contribution

Буду рад вашим коммитам, особенно если вы сопроводите их комментариями почему именно так, а не иначе. Это поможет мне узнавать новое.

И можно поддержать рублем: https://www.tinkoff.ru/sl/4wX5S96lj7t